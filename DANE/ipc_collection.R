#################################################
########## RECOLECCION IPC COLOMBIA #############
#################################################
cat("\014") # Limpiar la consola
while(dev.cur() > 1) dev.off() # Limpiar todos los gráficos
rm(list = ls()) # Limpiar el entorno global
library(rvest)
library(httr)
library(readxl)

# Configuración
dest_folder <- "Z:/03_Investigaciones_Economicas/2. Monitores/Colombia/Temporales"
page_url <- "https://www.dane.gov.co/index.php/estadisticas-por-tema/precios-y-costos/indice-de-precios-al-consumidor-ipc/ipc-informacion-tecnica#indices-y-ponderaciones"

# Función para descargar el archivo con manejo de errores y agente de usuario
download_dane_file <- function(link, dest_file) {
  tryCatch({
    if (!grepl("^http", link)) {
      link <- paste0("https://www.dane.gov.co", link)
    }
    r <- httr::GET(link, httr::user_agent("Mozilla/5.0"))
    
    if (httr::status_code(r) == 200) {
      writeBin(httr::content(r, "raw"), dest_file)
      cat("Archivo descargado con éxito:", dest_file, "\n")
    } else {
      stop("Error al descargar el archivo. Código de estado:", httr::status_code(r))
    }
  }, error = function(e) {
    cat("Error al descargar", link, ":", conditionMessage(e), "\n")
  })
}

# Leer el contenido de la página
page <- read_html(page_url)

# Extraer los enlaces de los archivos Excel
links <- page %>%
  html_nodes("a") %>%
  html_attr("href") %>%
  .[grepl("(?i)anex.*\\.xlsx$|gasto.*\\.xlsx$|enfoque.*\\.xlsx$", .)]

# Comprobar si se encontraron enlaces
if (length(links) == 0) {
  stop("No se encontraron archivos para descargar.")
}

# Procesar los nombres de los archivos
file_names <- sub(".*/(anex-.*?)-[^-]*\\.xlsx$", "\\1", links) 
file_names <- gsub("-", "_", file_names)

# Bucle para descargar cada archivo
for (i in seq_along(file_names)) {
  link <- links[i]
  dest_file <- paste0(dest_folder, "/", "DANE_", file_names[i], ".xlsx")
  download_dane_file(link, dest_file)
}

cat("Proceso completado.\n")

### IPC PRINCIPALES

cat("\014") # Limpiar la consola
while(dev.cur() > 1) dev.off() # Limpiar todos los gráficos
rm(list = ls()) # Limpiar el entorno global
library(openxlsx)
library(readxl)
library(tidyverse)

ruta_ipc = "Z:/03_Investigaciones_Economicas/2. Monitores/Colombia/Temporales/"

# Definimos la ruta del archivo
archivo <- "DANE_anex_IPC.xlsx"

# Creamos una lista vacía para almacenar los dataframes
lista_df <- list()

# Iteramos sobre las hojas del 10 al 16
for(i in 10:16){
  # Definimos las filas de inicio y las columnas a seleccionar según la hoja
  if(i == 10){
    startRow <- 9
    cols <- c("X3", "X9")
  } else if(i == 11){
    startRow <- 8
    cols <- "X3"
  } else {
    startRow <- 9
    cols <- "X3"
  }
  
  # Leemos la hoja correspondiente
  df <- read.xlsx(paste0(ruta_ipc, archivo), startRow = startRow, sheet = as.character(i), colNames = F)
  
  # Seleccionamos las columnas deseadas y eliminamos las filas con NA
  df <- df %>% select(cols) %>% na.omit()
  
  # Almacenamos el dataframe en la lista
  lista_df[[as.character(i)]] <- df
}

# Unimos todos los dataframes en la lista
df_unido <- bind_cols(lista_df)

# Seleccionamos solo los datos finales para pegar los del último mes
df_unido_final <- df_unido[nrow(df_unido),]

# # Define la ruta al archivo de Excel existente
ruta_excel <- "Z:/03_Investigaciones_Economicas/2. Monitores/Colombia/1. Actividad económica/"

libro = "IPC_dane.xlsx"
hoja = "Principales"

# Lee el archivo de Excel existente
wb <- loadWorkbook(paste0(ruta_excel, libro))

# Obtiene los datos de la hoja "Principales"
datos <- read.xlsx(wb, sheet = hoja)

# Encuentra la primera fila vacía en la columna 2
fila_vacia <- which(is.na(datos$X2))[1]+1

# Si no hay filas vacías, añade los datos en la siguiente fila
if(is.na(fila_vacia)){
  fila_vacia <- nrow(datos) + 2
}

# Escribe los datos en la hoja especificada a partir de la celda B3
writeData(wb, sheet = hoja, df_unido_final, startCol = 2, startRow = fila_vacia, colNames = F)

# Guarda los cambios en el archivo de Excel
saveWorkbook(wb, paste0(ruta_excel,libro), overwrite = TRUE)

### IPC DIVISIONES

cat("\014") # Limpiar la consola
while(dev.cur() > 1) dev.off() # Limpiar todos los gráficos
rm(list = ls()) # Limpiar el entorno global
library(openxlsx)
library(readxl)
library(tidyverse)

ruta_ipc = "Z:/03_Investigaciones_Economicas/2. Monitores/Colombia/Temporales/"

# Definimos la ruta del archivo
archivo <- "DANE_anex_IPC_divisiones_ingresos_total.xlsx"

df <- read.xlsx(paste0(ruta_ipc, archivo)
                            , startRow = 9 , colNames = F)

glimpse(df)

# Seleccionamos desde la columna 3 en adelante
df <- df[2:nrow(df),4:ncol(df)]
glimpse(df)

df <- data.frame(lapply(df, function(x) as.numeric(as.character(x))))
glimpse(df)
# Calcula el porcentaje de NA en cada fila
porcentaje_na <- colSums(is.na(df)) / nrow(df)
porcentaje_na

# Filtra las filas que tienen más de un 50% de NA
df <- df[,porcentaje_na <= 0.5] %>% na.omit()

glimpse(df)

# Transponer el df y convertirlo en formato tabla
df <- t(df) %>% as.data.frame()

# Seleccionamos solo los datos finales para pegar los del último mes
df <- df[nrow(df),]

# # Define la ruta al archivo de Excel existente
ruta_excel <- "Z:/03_Investigaciones_Economicas/2. Monitores/Colombia/1. Actividad económica/"

libro = "IPC_dane.xlsx"
hoja = "Divisiones"

# Lee el archivo de Excel existente
wb <- loadWorkbook(paste0(ruta_excel,libro))

# Obtiene los datos de la hoja "Principales"
datos <- read.xlsx(wb, sheet = hoja)

# Encuentra la primera fila vacía en la columna 2
fila_vacia <- which(is.na(datos$X2))[1]+1

# Si no hay filas vacías, añade los datos en la siguiente fila
if(is.na(fila_vacia)){
  fila_vacia <- nrow(datos) + 3
}

# Escribe los datos en la hoja especificada a partir de la celda B3
writeData(wb, sheet = hoja, df, startCol = 2, startRow = fila_vacia, colNames = F)

# Guarda los cambios en el archivo de Excel
saveWorkbook(wb, paste0(ruta_excel,libro), overwrite = TRUE)

### IPC GRUPOS

cat("\014") # Limpiar la consola
while(dev.cur() > 1) dev.off() # Limpiar todos los gráficos
rm(list = ls()) # Limpiar el entorno global
library(openxlsx)
library(readxl)
library(tidyverse)

ruta_ipc = "Z:/03_Investigaciones_Economicas/2. Monitores/Colombia/Temporales/"

# Definimos la ruta del archivo
archivo <- "DANE_anex_IPC_grupos_ingresos_total.xlsx"

df <- read.xlsx(paste0(ruta_ipc, archivo)
                , startRow = 9 , colNames = F)

glimpse(df)

# Seleccionamos desde la columna 3 en adelante
df <- df[2:nrow(df),4:ncol(df)]
glimpse(df)

df <- data.frame(lapply(df, function(x) as.numeric(as.character(x))))
glimpse(df)
# Calcula el porcentaje de NA en cada fila
porcentaje_na <- colSums(is.na(df)) / nrow(df)
porcentaje_na

# Filtra las filas que tienen más de un 50% de NA
df <- df[,porcentaje_na <= 0.5] %>% na.omit()

glimpse(df)

# Transponer el df y convertirlo en formato tabla
df <- t(df) %>% as.data.frame()

# Seleccionamos solo los datos finales para pegar los del último mes
df <- df[nrow(df),]

# # Define la ruta al archivo de Excel existente
ruta_excel <- "Z:/03_Investigaciones_Economicas/2. Monitores/Colombia/1. Actividad económica/"

libro = "IPC_dane.xlsx"
hoja = "Grupos"

# Lee el archivo de Excel existente
wb <- loadWorkbook(paste0(ruta_excel,libro))

# Obtiene los datos de la hoja "Principales"
datos <- read.xlsx(wb, sheet = hoja)

# Encuentra la primera fila vacía en la columna 2
fila_vacia <- which(is.na(datos[,2]))[1]+2

# Si no hay filas vacías, añade los datos en la siguiente fila
if(is.na(fila_vacia)){
  fila_vacia <- nrow(datos) + 3
}

# Escribe los datos en la hoja especificada a partir de la celda B3
writeData(wb, sheet = hoja, df, startCol = 2, startRow = fila_vacia, colNames = F)

# Guarda los cambios en el archivo de Excel
saveWorkbook(wb, paste0(ruta_excel,libro), overwrite = TRUE)


### IPC SUBCLASES

cat("\014") # Limpiar la consola
while(dev.cur() > 1) dev.off() # Limpiar todos los gráficos
rm(list = ls()) # Limpiar el entorno global
library(openxlsx)
library(readxl)
library(tidyverse)

ruta_ipc = "Z:/03_Investigaciones_Economicas/2. Monitores/Colombia/Temporales/"

# Definimos la ruta del archivo
archivo <- "DANE_anex_IPC_subclases_ingresos_total.xlsx"

df <- read.xlsx(paste0(ruta_ipc, archivo)
                , startRow = 9 , colNames = F)

glimpse(df)

# Seleccionamos desde la columna 3 en adelante
df <- df[2:nrow(df),4:ncol(df)]
glimpse(df)

df <- data.frame(lapply(df, function(x) as.numeric(as.character(x))))
glimpse(df)
# Calcula el porcentaje de NA en cada fila
porcentaje_na <- colSums(is.na(df)) / nrow(df)
porcentaje_na

# Filtra las filas que tienen más de un 50% de NA
df <- df[,porcentaje_na <= 0.5] %>% na.omit()

glimpse(df)

# Transponer el df y convertirlo en formato tabla
df <- t(df) %>% as.data.frame()

# Seleccionamos solo los datos finales para pegar los del último mes
df <- df[nrow(df),]

# # Define la ruta al archivo de Excel existente
ruta_excel <- "Z:/03_Investigaciones_Economicas/2. Monitores/Colombia/1. Actividad económica/"

libro = "IPC_dane.xlsx"
hoja = "Subclases"

# Lee el archivo de Excel existente
wb <- loadWorkbook(paste0(ruta_excel,libro))

# Obtiene los datos de la hoja "Principales"
datos <- read.xlsx(wb, sheet = hoja)

# Encuentra la primera fila vacía en la columna 2
fila_vacia <- which(is.na(datos[,2]))[1]+2

# Si no hay filas vacías, añade los datos en la siguiente fila
if(is.na(fila_vacia)){
  fila_vacia <- nrow(datos) + 3
}

# Escribe los datos en la hoja especificada a partir de la celda B3
writeData(wb, sheet = hoja, df, startCol = 2, startRow = fila_vacia, colNames = F)

# Guarda los cambios en el archivo de Excel
saveWorkbook(wb, paste0(ruta_excel,libro), overwrite = TRUE)

### IPC GENERAL

cat("\014") # Limpiar la consola
while(dev.cur() > 1) dev.off() # Limpiar todos los gráficos
rm(list = ls()) # Limpiar el entorno global
library(openxlsx)
library(readxl)
library(tidyverse)

ruta_ipc = "Z:/03_Investigaciones_Economicas/2. Monitores/Colombia/Temporales/"

# Definimos la ruta del archivo
archivo <- "DANE_anex_IPC_Indices.xlsx"

df <- read.xlsx(paste0(ruta_ipc, archivo)
                , startRow = 9 , colNames = T)

glimpse(df)

# Seleccionamos desde la columna 3 en adelante
df <- df[,ncol(df)] %>%  as.data.frame() %>% na.omit()
glimpse(df)

# Escogemos el dato final
df <- df[nrow(df),] %>% as.data.frame()

# # Define la ruta al archivo de Excel existente
ruta_excel <- "Z:/03_Investigaciones_Economicas/2. Monitores/Colombia/1. Actividad económica/"

libro = "IPC_dane.xlsx"
hoja = "General"

# Lee el archivo de Excel existente
wb <- loadWorkbook(paste0(ruta_excel,libro))

# Obtiene los datos de la hoja "Principales"
datos <- read.xlsx(wb, sheet = hoja)

# Encuentra la primera fila vacía en la columna 2
fila_vacia <- which(is.na(datos[,2]))[1]+2
fila_vacia
# Si no hay filas vacías, añade los datos en la siguiente fila
if(is.na(fila_vacia)){
  fila_vacia <- nrow(datos) + 3
}

# Escribe los datos en la hoja especificada a partir de la celda B3
writeData(wb, sheet = hoja, df, startCol = 2, startRow = fila_vacia, colNames = F)

# Guarda los cambios en el archivo de Excel
saveWorkbook(wb, paste0(ruta_excel,libro), overwrite = TRUE)


### INFORME IPC MENSUAL

cat("\014") # Limpiar la consola
while(dev.cur() > 1) dev.off() # Limpiar todos los gráficos
rm(list = ls()) # Limpiar el entorno global
library(openxlsx)
library(readxl)
library(tidyverse)
library(janitor)

ruta_ipc = "Z:/03_Investigaciones_Economicas/2. Monitores/Colombia/1. Actividad económica/"

# Definimos la ruta del archivo
archivo <- "IPC_dane.xlsx"

df <- read.xlsx(paste0(ruta_ipc, archivo) , colNames = T, sheet = "General")

df <- df[,1:2]
glimpse(df)

df_2 <- read.xlsx(paste0(ruta_ipc, archivo), startRow = 2 , colNames = T, sheet = "Principales") %>% clean_names()
glimpse(df_2)

df_2 <- df_2 %>% 
  select(date, sin_energeticos_ni_alimentos_coicop, servicios, energeticos)
glimpse(df_2)

df_union <- df %>% 
  left_join(df_2, by = "date")

df_union <- df_union %>% 
  select(-date)

ruta_excel = "Z:/03_Investigaciones_Economicas/2. Monitores/Colombia/2. Dashboard/Mensual/"

libro = "1. IPC_informe_mensual.xlsx"
hoja = "Datos"

# Lee el archivo de Excel existente
wb <- loadWorkbook(paste0(ruta_excel,libro))

# Escribe los datos en la hoja especificada a partir de la celda B3
writeData(wb, sheet = hoja, df_union, startCol = 2, startRow = 2, colNames = F)

# Guarda los cambios en el archivo de Excel
saveWorkbook(wb, paste0(ruta_excel,libro), overwrite = TRUE)


